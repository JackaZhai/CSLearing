<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>é‡åº†å¸‚å…¬å…±äº¤é€šå¯¼èˆª</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }
        .main-container {
            display: flex;
            height: 90vh;
            gap: 20px;
        }
        .map-container {
            width: 70%;
            height: 100%;
        }
        .function-container {
            width: 30%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #container {
            width: 100%;
            height: 100%;
        }
        .search-box {
            height: 50%;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .route-container {
            height: 50%;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
            overflow-y: auto;
        }
        .suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        .route-segment {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .transport-icon {
            margin-right: 10px;
        }
        .route-summary {
            background-color: #fff;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .route-options {
            margin: 20px 0;
        }
        .route-option {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1 class="text-center mb-4">é‡åº†å¸‚å…¬å…±äº¤é€šå¯¼èˆªç³»ç»Ÿ</h1>
    <div class="main-container">
        <div class="map-container">
            <div id="container"></div>
        </div>
        <div class="function-container">
            <div class="search-box">
                <div class="position-relative mb-3">
                    <label class="form-label">èµ·ç‚¹</label>
                    <input type="text" id="start" class="form-control" placeholder="è¯·è¾“å…¥èµ·ç‚¹">
                    <div id="startSuggestions" class="suggestions"></div>
                </div>
                <div class="position-relative mb-3">
                    <label class="form-label">ç»ˆç‚¹</label>
                    <input type="text" id="end" class="form-control" placeholder="è¯·è¾“å…¥ç»ˆç‚¹">
                    <div id="endSuggestions" class="suggestions"></div>
                </div>
                <div class="route-options">
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="timeFirst" value="0" checked>
                        <label class="form-check-label" for="timeFirst">æ—¶é—´æœ€å°‘</label>
                    </div>
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="distanceFirst" value="1">
                        <label class="form-check-label" for="distanceFirst">è·¯ç¨‹æœ€å°‘</label>
                    </div>
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="costFirst" value="2">
                        <label class="form-check-label" for="costFirst">èŠ±è´¹æœ€å°‘</label>
                    </div>
                </div>
                <button onclick="searchRoute()" class="btn btn-primary w-100">æŸ¥è¯¢è·¯çº¿</button>
            </div>
            <div class="route-container">
                <div id="routeInfo"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=41521a8555e416b14467c267d30d9c71"></script>
    <script>
        let map = new AMap.Map('container', {
            zoom: 11,
            center: [106.551556,29.563009]
        });

        let startLocation = null;
        let endLocation = null;
        let startMarker = null;
        let endMarker = null;
        let transitLine = null;
        let drivingLine = null;

        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        async function searchLocation(keyword, suggestionDiv, isStart) {
            if (!keyword) {
                suggestionDiv.style.display = 'none';
                return;
            }

            const response = await fetch(`/search_api?keyword=${encodeURIComponent(keyword)}`);
            const data = await response.json();

            suggestionDiv.innerHTML = '';
            if (data.pois && data.pois.length > 0) {
                data.pois.forEach(poi => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = poi.name;
                    div.onclick = () => {
                        if (isStart) {
                            document.getElementById('start').value = poi.name;
                            startLocation = poi.location;
                            updateMarker(true, poi.location);
                        } else {
                            document.getElementById('end').value = poi.name;
                            endLocation = poi.location;
                            updateMarker(false, poi.location);
                        }
                        suggestionDiv.style.display = 'none';
                    };
                    suggestionDiv.appendChild(div);
                });
                suggestionDiv.style.display = 'block';
            }
        }

        function updateMarker(isStart, location) {
            const [lng, lat] = location.split(',');
            if (isStart) {
                if (startMarker) {
                    startMarker.setMap(null);
                }
                startMarker = new AMap.Marker({
                    position: [lng, lat],
                    map: map
                });
            } else {
                if (endMarker) {
                    endMarker.setMap(null);
                }
                endMarker = new AMap.Marker({
                    position: [lng, lat],
                    map: map
                });
            }
        }

        function formatDuration(duration) {
            const minutes = Math.floor(duration / 60);
            return `${minutes}åˆ†é’Ÿ`;
        }

        function getTransportIcon(type) {
            switch(type) {
                case 'åœ°é“':
                    return 'ğŸš‡';
                case 'å…¬äº¤':
                    return 'ğŸšŒ';
                case 'æ­¥è¡Œ':
                    return 'ğŸš¶';
                default:
                    return 'ğŸš¶';
            }
        }

        async function searchRoute() {
            if (!startLocation || !endLocation) {
                alert('è¯·å…ˆé€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹');
                return;
            }

            const routeInfoDiv = document.getElementById('routeInfo');
            routeInfoDiv.innerHTML = '<div class="alert alert-info">è·¯å¾„è§„åˆ’ä¸­...</div>';
            await new Promise(resolve => setTimeout(resolve, 6000));
            // è·å–é€‰ä¸­çš„è·¯çº¿è§„åˆ’ç­–ç•¥
            const strategy = document.querySelector('input[name="routeStrategy"]:checked').value;

            // æ¸…é™¤ç°æœ‰è·¯çº¿
            if (transitLine) {
                transitLine.setMap(null);
            }
            if (drivingLine) {
                drivingLine.setMap(null);
            }

            const response = await fetch(`/route_api?origin=${startLocation}&destination=${endLocation}&strategy=${strategy}`);
            const data = await response.json();

            //const routeInfoDiv = document.getElementById('routeInfo');
            routeInfoDiv.innerHTML = '';


            // å¤„ç†å…¬äº¤è·¯çº¿
            if (data.transit.route && data.transit.route.transits && data.transit.route.transits.length > 0) {
                const transit = data.transit.route.transits[0];
                
                // æ·»åŠ è·¯çº¿æ¦‚è¦ä¿¡æ¯
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'route-summary';
                summaryDiv.innerHTML = `
                    <h5>å…¬äº¤è·¯çº¿æ¦‚è¦</h5>
                    <p>æ€»è·ç¦»: ${(transit.distance/1000).toFixed(1)}å…¬é‡Œ</p>
                    <p>é¢„è®¡æ—¶é—´: ${formatDuration(transit.duration)}</p>
                    <p>é¢„è®¡èŠ±è´¹: ${transit.cost}å…ƒ</p>
                `;
                routeInfoDiv.appendChild(summaryDiv);

                // æ·»åŠ è¯¦ç»†è·¯æ®µä¿¡æ¯
                transit.segments.forEach((segment, index) => {
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'route-segment';
                    
                    if (segment.walking) {
                        const walkingDistance = isNaN(segment.walking.distance) ? 0 : (segment.walking.distance / 1000).toFixed(2);
                        segmentDiv.innerHTML = `
                            <div>
                                <span class="transport-icon">ğŸš¶</span>
                                <span>æ­¥è¡Œ ${walkingDistance}å…¬é‡Œ</span>
                            </div>
                        `;
                    }
                    
                    if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
                        const busline = segment.bus.buslines[0];
                        const isSubway = busline.type === 'åœ°é“';
                        segmentDiv.innerHTML += `
                            <div>
                                <span class="transport-icon">${isSubway ? 'ğŸš‡' : 'ğŸšŒ'}</span>
                                <strong>${busline.name}</strong><br>
                                <small>ä» ${busline.departure_stop.name} åˆ° ${busline.arrival_stop.name}</small><br>
                                <small>${busline.via_num}ç«™ | ${formatDuration(busline.duration)}</small>
                            </div>
                        `;
                    }
                    
                    routeInfoDiv.appendChild(segmentDiv);
                });

                // ç»˜åˆ¶å…¬äº¤è·¯çº¿
                let transitPoints = [];
                transit.segments.forEach(segment => {
                    if (segment.walking && segment.walking.steps) {
                        segment.walking.steps.forEach(step => {
                            if (step.polyline) {
                                const points = step.polyline.split(';').map(point => {
                                    const [lng, lat] = point.split(',');
                                    return [parseFloat(lng), parseFloat(lat)];
                                });
                                transitPoints = transitPoints.concat(points);
                            }
                        });
                    }
                    if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
                        const busline = segment.bus.buslines[0];
                        if (busline.polyline) {
                            const points = busline.polyline.split(';').map(point => {
                                const [lng, lat] = point.split(',');
                                return [parseFloat(lng), parseFloat(lat)];
                            });
                            transitPoints = transitPoints.concat(points);
                        }
                    }
                });

                if (transitPoints.length > 0) {
                    transitLine = new AMap.Polyline({
                        path: transitPoints,
                        strokeColor: '#3366FF',  // è“è‰²
                        strokeWeight: 6,
                        strokeOpacity: 0.8,
                        showDir: true
                    });
                    transitLine.setMap(map);
                }
            } else {
                routeInfoDiv.innerHTML += '<div class="alert alert-warning">æœªæ‰¾åˆ°åˆé€‚çš„å…¬äº¤è·¯çº¿</div>';
            }

            /* å¤„ç†é©¾è½¦è·¯çº¿
            if (data.driving.route && data.driving.route.paths && data.driving.route.paths.length > 0) {
                const path = data.driving.route.paths[0];
                let drivingPoints = [];

                path.steps.forEach(step => {
                    if (step.polyline) {
                        const points = step.polyline.split(';').map(point => {
                            const [lng, lat] = point.split(',');
                            return [parseFloat(lng), parseFloat(lat)];
                        });
                        drivingPoints = drivingPoints.concat(points);
                    }
                });

                if (drivingPoints.length > 0) {
                    drivingLine = new AMap.Polyline({
                        path: drivingPoints,
                        strokeColor: '#FF3366',  // çº¢è‰²
                        strokeWeight: 6,
                        strokeOpacity: 0.6,
                        strokeStyle: 'dashed',
                        showDir: true
                    });
                    drivingLine.setMap(map);
                }

                // æ·»åŠ é©¾è½¦è·¯çº¿æ¦‚è¦
                const drivingSummaryDiv = document.createElement('div');
                drivingSummaryDiv.className = 'route-summary';
                drivingSummaryDiv.innerHTML = `
                    <h5>é©¾è½¦è·¯çº¿æ¦‚è¦</h5>
                    <p>æ€»è·ç¦»: ${(path.distance/1000).toFixed(1)}å…¬é‡Œ</p>
                    <p>é¢„è®¡æ—¶é—´: ${formatDuration(path.duration)}</p>
                `;
                routeInfoDiv.appendChild(drivingSummaryDiv);
            }
            */

            // è°ƒæ•´åœ°å›¾è§†é‡
            const overlays = [startMarker, endMarker];
            if (transitLine) overlays.push(transitLine);
            if (drivingLine) overlays.push(drivingLine);
            map.setFitView(overlays);
        }

        document.getElementById('start').addEventListener('input', 
            debounce(e => searchLocation(e.target.value, document.getElementById('startSuggestions'), true), 500)
        );

        document.getElementById('end').addEventListener('input',
            debounce(e => searchLocation(e.target.value, document.getElementById('endSuggestions'), false), 500)
        );

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—å»ºè®®åˆ—è¡¨
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.position-relative')) {
                document.getElementById('startSuggestions').style.display = 'none';
                document.getElementById('endSuggestions').style.display = 'none';
            }
        });
    </script>
</body>
</html> 