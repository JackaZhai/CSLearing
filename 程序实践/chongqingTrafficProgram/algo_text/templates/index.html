<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>é‡åº†å¸‚å…¬å…±äº¤é€šå¯¼èˆª</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }
        .main-container {
            display: flex;
            height: 90vh;
            gap: 20px;
        }
        .map-container {
            width: 70%;
            height: 100%;
        }
        .function-container {
            width: 30%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #container {
            width: 100%;
            height: 100%;
        }
        .search-box {
            height: 50%;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .route-container {
            height: 50%;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
            overflow-y: auto;
        }
        .suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        .route-segment {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .transport-icon {
            margin-right: 10px;
        }
        .route-summary {
            background-color: #fff;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .route-options {
            margin: 20px 0;
        }
        .route-option {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1 class="text-center mb-4">é‡åº†å¸‚å…¬å…±äº¤é€šå¯¼èˆªç³»ç»Ÿ</h1>
    <div class="main-container">
        <div class="map-container">
            <div id="container"></div>
        </div>
        <div class="function-container">
            <div class="search-box">
                <div class="position-relative mb-3">
                    <label class="form-label">èµ·ç‚¹</label>
                    <input type="text" id="start" class="form-control" placeholder="è¯·è¾“å…¥èµ·ç‚¹">
                    <div id="startSuggestions" class="suggestions"></div>
                </div>
                <div class="position-relative mb-3">
                    <label class="form-label">ç»ˆç‚¹</label>
                    <input type="text" id="end" class="form-control" placeholder="è¯·è¾“å…¥ç»ˆç‚¹">
                    <div id="endSuggestions" class="suggestions"></div>
                </div>
                <div class="route-options">
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="timeFirst" value="0" checked>
                        <label class="form-check-label" for="timeFirst">æ—¶é—´æœ€å°‘</label>
                    </div>
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="distanceFirst" value="1">
                        <label class="form-check-label" for="distanceFirst">è·¯ç¨‹æœ€å°‘</label>
                    </div>
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="costFirst" value="2">
                        <label class="form-check-label" for="costFirst">èŠ±è´¹æœ€å°‘</label>
                    </div>
                </div>
                <button onclick="searchRoute()" class="btn btn-primary w-100">æŸ¥è¯¢è·¯çº¿</button>
            </div>
            <div class="route-container">
                <div id="routeInfo"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=41521a8555e416b14467c267d30d9c71"></script>
    <script>
        let map = new AMap.Map('container', {
            zoom: 11,
            center: [106.551556,29.563009]
        });

        let startLocation = null;
        let endLocation = null;
        let startMarker = null;
        let endMarker = null;
        let transitLine = null;
        let drivingLine = null;

        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        async function searchLocation(keyword, suggestionDiv, isStart) {
            if (!keyword) {
                suggestionDiv.style.display = 'none';
                return;
            }

            const response = await fetch(`/search?keyword=${encodeURIComponent(keyword)}`);
            const data = await response.json();

            suggestionDiv.innerHTML = '';
            if (data.pois && data.pois.length > 0) {
                data.pois.forEach(poi => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = poi.name;
                    div.onclick = () => {
                        if (isStart) {
                            document.getElementById('start').value = poi.name;
                            startLocation = poi.location;
                            updateMarker(true, poi.location);
                        } else {
                            document.getElementById('end').value = poi.name;
                            endLocation = poi.location;
                            updateMarker(false, poi.location);
                        }
                        suggestionDiv.style.display = 'none';
                    };
                    suggestionDiv.appendChild(div);
                });
                suggestionDiv.style.display = 'block';
            }
        }

        function updateMarker(isStart, location) {
            const [lng, lat] = location.split(',');
            if (isStart) {
                if (startMarker) {
                    startMarker.setMap(null);
                }
                startMarker = new AMap.Marker({
                    position: [lng, lat],
                    map: map
                });
            } else {
                if (endMarker) {
                    endMarker.setMap(null);
                }
                endMarker = new AMap.Marker({
                    position: [lng, lat],
                    map: map
                });
            }
        }

        function formatDuration(duration) {
            const minutes = Math.floor(duration / 60);
            return `${minutes}åˆ†é’Ÿ`;
        }

        function getTransportIcon(type) {
            switch(type) {
                case 'åœ°é“':
                    return 'ğŸš‡';
                case 'å…¬äº¤':
                    return 'ğŸšŒ';
                case 'æ­¥è¡Œ':
                    return 'ğŸš¶';
                default:
                    return 'ğŸš¶';
            }
        }

        async function searchRoute() {
            if (!startLocation || !endLocation) {
                alert('è¯·å…ˆé€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹');
                return;
            }

            const routeInfoDiv = document.getElementById('routeInfo');
            routeInfoDiv.innerHTML = '<div class="alert alert-info">æ­£åœ¨è§„åˆ’è·¯çº¿...</div>';

            try {
                // è·å–é€‰ä¸­çš„è·¯çº¿è§„åˆ’ç­–ç•¥
                const strategy = document.querySelector('input[name="routeStrategy"]:checked').value;

                // æ¸…é™¤ç°æœ‰è·¯çº¿
                if (transitLine) {
                    transitLine.setMap(null);
                }
                if (drivingLine) {
                    drivingLine.setMap(null);
                }

                const response = await fetch(`/route?origin=${startLocation}&destination=${endLocation}&strategy=${strategy}`);
                const data = await response.json();

                routeInfoDiv.innerHTML = '';

                if (data.status === '0') {
                    routeInfoDiv.innerHTML = `<div class="alert alert-warning">${data.info || 'æœªæ‰¾åˆ°åˆé€‚çš„è·¯çº¿'}</div>`;
                    return;
                }

                // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                if (!data || !data.route || !data.route.transits || !data.route.transits.length) {
                    routeInfoDiv.innerHTML = '<div class="alert alert-warning">æœªæ‰¾åˆ°åˆé€‚çš„å…¬äº¤è·¯çº¿</div>';
                    return;
                }

                const transit = data.route.transits[0];
                
                // æ·»åŠ è·¯çº¿æ¦‚è¦ä¿¡æ¯
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'route-summary';
                summaryDiv.innerHTML = `
                    <h5>è·¯çº¿æ¦‚è¦</h5>
                    <p>æ€»æ—¶é—´ï¼š${formatDuration(transit.duration || 0)}</p>
                    <p>æ­¥è¡Œè·ç¦»ï¼š${((transit.walking_distance || 0)/1000).toFixed(2)}å…¬é‡Œ</p>
                    <p>èŠ±è´¹ï¼š${formatCost(transit.cost)}å…ƒ</p>
                `;
                routeInfoDiv.appendChild(summaryDiv);

                // å¦‚æœæœ‰è¯¦ç»†è·¯å¾„ä¿¡æ¯ï¼Œæ˜¾ç¤ºè·¯å¾„
                if (transit.path && transit.path.stations && transit.path.stations.length > 0) {
                    const pathDiv = document.createElement('div');
                    pathDiv.className = 'route-details';
                    pathDiv.innerHTML = '<h5>è¯¦ç»†è·¯çº¿</h5>';

                    // åˆ›å»ºè·¯å¾„ç‚¹æ•°ç»„ç”¨äºç»˜åˆ¶åœ°å›¾
                    const pathPoints = [];

                    transit.path.stations.forEach((station, index) => {
                        if (!station) return;  // è·³è¿‡æ— æ•ˆç«™ç‚¹

                        const stationDiv = document.createElement('div');
                        stationDiv.className = 'route-segment';
                        
                        // è·å–äº¤é€šæ–¹å¼å›¾æ ‡
                        let transportType = 'æ­¥è¡Œ';
                        if (index < transit.path.lines.length) {
                            const line = transit.path.lines[index];
                            if (line && (line.includes('åœ°é“') || line.includes('è½¨é“'))) {
                                transportType = 'åœ°é“';
                            } else if (line && line.includes('å…¬äº¤')) {
                                transportType = 'å…¬äº¤';
                            }
                        }
                        
                        stationDiv.innerHTML = `
                            <span class="transport-icon">${getTransportIcon(transportType)}</span>
                            <span>${station.name || 'æœªçŸ¥ç«™ç‚¹'}</span>
                        `;
                        pathDiv.appendChild(stationDiv);

                        // æ·»åŠ ç«™ç‚¹åˆ°è·¯å¾„ç‚¹æ•°ç»„
                        if (station.location && Array.isArray(station.location) && station.location.length >= 2) {
                            pathPoints.push(new AMap.LngLat(station.location[1], station.location[0]));
                        }
                    });

                    routeInfoDiv.appendChild(pathDiv);

                    // åœ¨åœ°å›¾ä¸Šç»˜åˆ¶è·¯çº¿
                    if (pathPoints.length > 0) {
                        transitLine = new AMap.Polyline({
                            path: pathPoints,
                            strokeColor: '#3366FF',
                            strokeWeight: 6,
                            strokeOpacity: 0.8
                        });
                        transitLine.setMap(map);
                        
                        // è°ƒæ•´åœ°å›¾è§†é‡ä»¥åŒ…å«æ•´ä¸ªè·¯çº¿
                        map.setFitView([transitLine]);
                    }
                } else {
                    routeInfoDiv.innerHTML += '<div class="alert alert-warning">æ— æ³•æ˜¾ç¤ºè¯¦ç»†è·¯çº¿ä¿¡æ¯</div>';
                }
            } catch (error) {
                console.error('è·¯çº¿è§„åˆ’å‡ºé”™:', error);
                routeInfoDiv.innerHTML = '<div class="alert alert-danger">è·¯çº¿è§„åˆ’å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        document.getElementById('start').addEventListener('input', 
            debounce(e => searchLocation(e.target.value, document.getElementById('startSuggestions'), true), 500)
        );

        document.getElementById('end').addEventListener('input',
            debounce(e => searchLocation(e.target.value, document.getElementById('endSuggestions'), false), 500)
        );

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—å»ºè®®åˆ—è¡¨
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.position-relative')) {
                document.getElementById('startSuggestions').style.display = 'none';
                document.getElementById('endSuggestions').style.display = 'none';
            }
        });

        function formatCost(cost) {
            if (!cost) return '0';
            
            // å¦‚æœcostæ˜¯å­—ç¬¦ä¸²ï¼Œå…ˆè½¬æ¢ä¸ºæ•°å­—
            const costNum = typeof cost === 'string' ? parseFloat(cost) : cost;
            
            // å¦‚æœæ•°å­—æ— æ•ˆï¼Œè¿”å›0
            if (isNaN(costNum)) return '0';
            
            // å¦‚æœcostæ˜¯è·ç¦»å€¼ï¼ˆä»¥ç±³ä¸ºå•ä½ï¼‰ï¼Œè½¬æ¢ä¸ºåˆç†çš„èŠ±è´¹é‡‘é¢
            // å‡è®¾æ¯å…¬é‡Œ2å…ƒé’±
            const kilometers = costNum / 1000;  // è½¬æ¢ä¸ºå…¬é‡Œ
            const estimatedCost = kilometers * 2;  // æ¯å…¬é‡Œ2å…ƒ
            
            // è¿”å›ä¼°ç®—çš„èŠ±è´¹é‡‘é¢ï¼Œä¿ç•™1ä½å°æ•°
            return estimatedCost.toFixed(1);
        }
    </script>
</body>
</html> 