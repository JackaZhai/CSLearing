<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>重庆市公共交通导航</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }
        .main-container {
            display: flex;
            height: 90vh;
            gap: 20px;
        }
        .map-container {
            width: 70%;
            height: 100%;
        }
        .function-container {
            width: 30%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #container {
            width: 100%;
            height: 100%;
        }
        .search-box {
            height: 50%;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .route-container {
            height: 50%;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
            overflow-y: auto;
        }
        .suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        .route-segment {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .transport-icon {
            margin-right: 10px;
        }
        .route-summary {
            background-color: #fff;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .route-options {
            margin: 20px 0;
        }
        .route-option {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1 class="text-center mb-4">重庆市公共交通导航系统</h1>
    <div class="main-container">
        <div class="map-container">
            <div id="container"></div>
        </div>
        <div class="function-container">
            <div class="search-box">
                <div class="position-relative mb-3">
                    <label class="form-label">起点</label>
                    <input type="text" id="start" class="form-control" placeholder="请输入起点">
                    <div id="startSuggestions" class="suggestions"></div>
                </div>
                <div class="position-relative mb-3">
                    <label class="form-label">终点</label>
                    <input type="text" id="end" class="form-control" placeholder="请输入终点">
                    <div id="endSuggestions" class="suggestions"></div>
                </div>
                <div class="route-options">
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="timeFirst" value="0" checked>
                        <label class="form-check-label" for="timeFirst">时间最少</label>
                    </div>
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="distanceFirst" value="1">
                        <label class="form-check-label" for="distanceFirst">路程最少</label>
                    </div>
                    <div class="form-check route-option">
                        <input class="form-check-input" type="radio" name="routeStrategy" id="costFirst" value="2">
                        <label class="form-check-label" for="costFirst">花费最少</label>
                    </div>
                </div>
                <button onclick="searchRoute()" class="btn btn-primary w-100">查询路线</button>
            </div>
            <div class="route-container">
                <div id="routeInfo"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=41521a8555e416b14467c267d30d9c71"></script>
    <script>
        let map = new AMap.Map('container', {
            zoom: 11,
            center: [106.551556,29.563009]
        });

        let startLocation = null;
        let endLocation = null;
        let startMarker = null;
        let endMarker = null;
        let transitLine = null;
        let drivingLine = null;

        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        async function searchLocation(keyword, suggestionDiv, isStart) {
            if (!keyword) {
                suggestionDiv.style.display = 'none';
                return;
            }

            const response = await fetch(`/search?keyword=${encodeURIComponent(keyword)}`);
            const data = await response.json();

            suggestionDiv.innerHTML = '';
            if (data.pois && data.pois.length > 0) {
                data.pois.forEach(poi => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = poi.name;
                    div.onclick = () => {
                        if (isStart) {
                            document.getElementById('start').value = poi.name;
                            startLocation = poi.location;
                            updateMarker(true, poi.location);
                        } else {
                            document.getElementById('end').value = poi.name;
                            endLocation = poi.location;
                            updateMarker(false, poi.location);
                        }
                        suggestionDiv.style.display = 'none';
                    };
                    suggestionDiv.appendChild(div);
                });
                suggestionDiv.style.display = 'block';
            }
        }

        function updateMarker(isStart, location) {
            const [lng, lat] = location.split(',');
            if (isStart) {
                if (startMarker) {
                    startMarker.setMap(null);
                }
                startMarker = new AMap.Marker({
                    position: [lng, lat],
                    map: map
                });
            } else {
                if (endMarker) {
                    endMarker.setMap(null);
                }
                endMarker = new AMap.Marker({
                    position: [lng, lat],
                    map: map
                });
            }
        }

        function formatDuration(duration) {
            const minutes = Math.floor(duration / 60);
            return `${minutes}分钟`;
        }

        function getTransportIcon(type) {
            switch(type) {
                case '地铁':
                    return '🚇';
                case '公交':
                    return '🚌';
                case '步行':
                    return '🚶';
                default:
                    return '🚶';
            }
        }

        async function searchRoute() {
            if (!startLocation || !endLocation) {
                alert('请先选择起点和终点');
                return;
            }

            const routeInfoDiv = document.getElementById('routeInfo');
            routeInfoDiv.innerHTML = '<div class="alert alert-info">正在规划路线...</div>';

            try {
                // 获取选中的路线规划策略
                const strategy = document.querySelector('input[name="routeStrategy"]:checked').value;

                // 清除现有路线
                if (transitLine) {
                    transitLine.setMap(null);
                }
                if (drivingLine) {
                    drivingLine.setMap(null);
                }

                const response = await fetch(`/route?origin=${startLocation}&destination=${endLocation}&strategy=${strategy}`);
                const data = await response.json();

                routeInfoDiv.innerHTML = '';

                if (data.status === '0') {
                    routeInfoDiv.innerHTML = `<div class="alert alert-warning">${data.info || '未找到合适的路线'}</div>`;
                    return;
                }

                // 检查数据完整性
                if (!data || !data.route || !data.route.transits || !data.route.transits.length) {
                    routeInfoDiv.innerHTML = '<div class="alert alert-warning">未找到合适的公交路线</div>';
                    return;
                }

                const transit = data.route.transits[0];
                
                // 添加路线概要信息
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'route-summary';
                summaryDiv.innerHTML = `
                    <h5>路线概要</h5>
                    <p>总时间：${formatDuration(transit.duration || 0)}</p>
                    <p>步行距离：${((transit.walking_distance || 0)/1000).toFixed(2)}公里</p>
                    <p>花费：${formatCost(transit.cost)}元</p>
                `;
                routeInfoDiv.appendChild(summaryDiv);

                // 如果有详细路径信息，显示路径
                if (transit.path && transit.path.stations && transit.path.stations.length > 0) {
                    const pathDiv = document.createElement('div');
                    pathDiv.className = 'route-details';
                    pathDiv.innerHTML = '<h5>详细路线</h5>';

                    // 创建路径点数组用于绘制地图
                    const pathPoints = [];

                    transit.path.stations.forEach((station, index) => {
                        if (!station) return;  // 跳过无效站点

                        const stationDiv = document.createElement('div');
                        stationDiv.className = 'route-segment';
                        
                        // 获取交通方式图标
                        let transportType = '步行';
                        if (index < transit.path.lines.length) {
                            const line = transit.path.lines[index];
                            if (line && (line.includes('地铁') || line.includes('轨道'))) {
                                transportType = '地铁';
                            } else if (line && line.includes('公交')) {
                                transportType = '公交';
                            }
                        }
                        
                        stationDiv.innerHTML = `
                            <span class="transport-icon">${getTransportIcon(transportType)}</span>
                            <span>${station.name || '未知站点'}</span>
                        `;
                        pathDiv.appendChild(stationDiv);

                        // 添加站点到路径点数组
                        if (station.location && Array.isArray(station.location) && station.location.length >= 2) {
                            pathPoints.push(new AMap.LngLat(station.location[1], station.location[0]));
                        }
                    });

                    routeInfoDiv.appendChild(pathDiv);

                    // 在地图上绘制路线
                    if (pathPoints.length > 0) {
                        transitLine = new AMap.Polyline({
                            path: pathPoints,
                            strokeColor: '#3366FF',
                            strokeWeight: 6,
                            strokeOpacity: 0.8
                        });
                        transitLine.setMap(map);
                        
                        // 调整地图视野以包含整个路线
                        map.setFitView([transitLine]);
                    }
                } else {
                    routeInfoDiv.innerHTML += '<div class="alert alert-warning">无法显示详细路线信息</div>';
                }
            } catch (error) {
                console.error('路线规划出错:', error);
                routeInfoDiv.innerHTML = '<div class="alert alert-danger">路线规划失败，请稍后重试</div>';
            }
        }

        document.getElementById('start').addEventListener('input', 
            debounce(e => searchLocation(e.target.value, document.getElementById('startSuggestions'), true), 500)
        );

        document.getElementById('end').addEventListener('input',
            debounce(e => searchLocation(e.target.value, document.getElementById('endSuggestions'), false), 500)
        );

        // 点击其他地方时隐藏建议列表
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.position-relative')) {
                document.getElementById('startSuggestions').style.display = 'none';
                document.getElementById('endSuggestions').style.display = 'none';
            }
        });

        function formatCost(cost) {
            if (!cost) return '0';
            
            // 如果cost是字符串，先转换为数字
            const costNum = typeof cost === 'string' ? parseFloat(cost) : cost;
            
            // 如果数字无效，返回0
            if (isNaN(costNum)) return '0';
            
            // 如果cost是距离值（以米为单位），转换为合理的花费金额
            // 假设每公里2元钱
            const kilometers = costNum / 1000;  // 转换为公里
            const estimatedCost = kilometers * 2;  // 每公里2元
            
            // 返回估算的花费金额，保留1位小数
            return estimatedCost.toFixed(1);
        }
    </script>
</body>
</html> 